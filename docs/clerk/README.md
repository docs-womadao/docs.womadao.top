# 机器人“店员”使用文档  

>###### 该页面主要由cx维护,嘻嘻

>该文档不保证内容的时效性，随缘更新，若有问题请联系橙息。最后更新日期：2025年7月31日

> 删除线划掉的内容表示已经废弃或者暂时关闭的功能

## 一、介绍
- **店员版本：** 4.0
- **QQ频道**：[沃玛「Warma」](http://warma.fans)
- **QQ群**: [沃玛频道——🍉日常闲聊](https://qm.qq.com/q/X69yIwDWEw)
- **店员B站账号**: [@店店店店员](https://space.bilibili.com/3546648718346997)
- **开发者**：[橙息](https://space.bilibili.com/112978436)
- **设定**：来自b站up主[@warma](https://space.bilibili.com/53456)的作品中出现的角色“店员”
- **功能**：基于deepseek等AI模型的聊天机器人，可以同时与**多人**进行**连续**的文字聊天，语音聊天，识别图像等

### 使用到的AI模型
- **大语言模型：**[DeepSeek-V3](https://deepseek.com/)
- **记忆处理模型：**[DeepSeek-R1](https://deepseek.com/)
- **视觉模型：**[qwen-vl-plus](https://tongyi.aliyun.com/qianwen/)(通义千问视觉模型)
- **语音识别模型：**[Paraformer语音识别-中文-通用-16k-离线-large-pytorch](https://www.modelscope.cn/models/iic/speech_paraformer-large_asr_nat-zh-cn-16k-common-vocab8404-pytorch)
- **语音合成模型：**[GPT-SoVITS-v2](https://github.com/RVC-Boss/GPT-SoVITS)

>以下内容中以 **频道** 指代QQ聊群/QQ私信/QQ频道子频道

### 基本功能特性
1. **白名单**：需要橙息手动为频道添加白名单才能使用店员的所有功能
2. ~~**闭嘴**：当店员处于闭嘴状态的时候，无法在频道中通过 `@店员` 除外的方式触发AI回复~~（已删除）
3. **防刷屏**：主要是为了防止店员与其他机器人（贝拉）触发循环对话
    - 判定方式：在触发店员AI对话的时候，判断最近5条消息是否包含2条店员消息，并且5条消息的时间间隔小于8秒，如果是则不触发AI回复
4. **自动宵禁**：当自动宵禁功能开启，非节假日00:00-06:00自动开启全员禁言
5. **生日提醒**：根据聊群用户在qq设置的生日，在每日的8点整自动为用户献上生日祝福
6. **语音输出**：在触发店员AI聊天时，在发送的文本最后加上 "**-a**" 可以让店员使用语言+文本回答用户的问题
7. **连锁撤回**：当用户撤回了一条已触发店员回复的消息（包括指令、AI回复等）时，店员会自动撤回回复的消

## 二、店员AI聊天功能

### **基本特性**
- 锁机制：店员AI在每个频道中一次只能处理一个用户的消息。当有消息正在处理的时候，其他用户的消息会被忽略。
- 表情状态：
    - 当成功手动触发AI回复的时候，会给用户的消息贴上表情状态“✨”
    - 当用户的消息因为锁机制被忽略的时候，会给用户的消息贴上表情状态“💤”
    - 当出现错误的时候，会给用户的消息贴上表情状态“❌”

### **触发AI对话的方式**：
- 在聊群中发送带有“**店员**”二字的消息
- 在聊群中 `@店员` 或消息以`@店员`开头
- **引用**店员的消息
- 在私信中发送**任意**消息
- ~~在聊群中有 **1%** 的概率触发店员的**主动**AI回复~~（已删除）
- 当提出**具体的**可被**客观**解答的不受环境、时间约束的问题时，不带触发词（店员）也会有可能自动触发AI回复
    - 例如：
        - “鲁迅的代表作有哪些？”
        - “Python的列表和元组有什么区别？”
        - “深度学习的基本概念是什么？”
- 若消息中包含`**`（双星号）或者`#`（井号）则任何情况下都**不会**触发AI回复
- 当使用指令`@店员 切换店员自动回复`关闭店员自动回复时，**不会**触发关键词回复、提问回复和引用回复（不包括@回复）。
- 有新用户**加入聊群**，自动触发AI回复欢迎新用户

- 在以下QQ频道帖子板块发帖/评论区提到“店员”会触发店员AI回复
    - [💥 日常帖子](https://pd.qq.com/g/WarmaFans1026?subc=1590402)
    - [💥 日常帖子](https://pd.qq.com/g/WarmaFans1026?subc=3020979)
    - [🎨 创作分享](https://pd.qq.com/g/WarmaFans1026?subc=671207769)

### **短期记忆** {#2-2}
- 在每个频道都会有**15**条对话上下文（又称短期记忆）
- 记忆包括用户的对话（没有触发AI回复的消息）
- 还包括**店员自己发送的消息**
- 超过**15**条后会自动删除最早的一条对话。
- 店员可以结合这**15**条消息来回答用户的问题。

### **长期记忆**
- 店员会在聊天中自动整理记忆到向量数据库中，包括**新增**/**更新**/**删除**记忆
- 店员会在回答问题时根据提问调用数据库中最匹配的**15条**记忆条目
- 使用了阿里云的[DashVector向量检索服务](https://dashvector.console.aliyun.com)
- 使用了阿里云的[通用文本向量模型text-embedding-v2](https://help.aliyun.com/zh/dashscope/developer-reference/generic-text-vector)

### **可用信息**
- 用户发送的**消息文本**
- 用户在聊群中的**昵称**
- 当前的**时间** （格式为：YYYY-mm-dd HH:MM:SS）
- **频道名称**
- 当天生日的群员列表
- 近期的节日信息

### **店员接受的格式**
- **文本**内容
- **图片**：可以是**引用**的**图片**，又或是`图片`+`文字`混合（自定义表情包将作为图片处理）
    >图片会先传递给**qwen-vl-plus**模型进行识别，识别结果会作为**文字**代替文本消息中的**图片**传递给**DeepSeek-V3**模型，**DeepSeek-V3**模型会根据识别结果回复
    - **图片识别的具体特性：**
        - 发送的图片会在**触发店员AI回复的时候**自动识别转换为图片描述（仅限后5条消息中的图片）
        - 引用的图片/表情包会在**触发店员AI回复的时候**自动识别转换为图片描述(不受上述限制)
        - 用户自定义表情包（动画表情）不会自动识别转换为图片描述，需要**引用**的方式来手动触发
- **qq emoji**：转为对应的**文字**名称
- **qq表情包**：转为对应的**文字**名称
- **语音**：语音识别，使用了[Paraformer语音识别-中文-通用-16k-离线-large-pytorch](https://www.modelscope.cn/models/iic/speech_paraformer-large_asr_nat-zh-cn-16k-common-vocab8404-pytorch)来语音识别（只支持中文）
- **引用消息**：可获取引用的消息**文本**内容和发送者的**昵称**，如果引用的消息包含**图片**也会按照上述方式处理
- **部分json格式**：如转发的APP分享（B站，网易云音乐等）
- **其他格式**：无法处理合并转发消息、文件、视频等格式

### **店员可输出的格式**
- **文本**内容。（现在支持一次发送多条消息）
- **语音**: 使用[GPT-SoVITS-v2](https://github.com/RVC-Boss/GPT-SoVITS)来合成语音


## 三、[店员指令功能](COMMANDS.md)

## 四、微博动态推送

> **微博/B站动态推送的子频道频道/帖子板块/聊群**
    - [🍬「焦糖星热点」更新推送](https://pd.qq.com/g/WarmaFans1026/text/1299996)
    - [📢 动态推送](https://pd.qq.com/g/WarmaFans1026?subc=670672675)
    - [沃玛频道——🍉日常闲聊](https://qm.qq.com/q/X69yIwDWEw)

- 以`图片`的形式自动推送微博[@_warma_](https://weibo.com/u/1782488734)的动态到上述频道
- 将动态中的**图片**逐个提取并发送到上述频道
- 如果动态包含**视频**，会自动发送**视频文件**到上述频道（[🍬「焦糖星热点」更新推送](https://pd.qq.com/g/WarmaFans1026/text/1299996) 除外）

## 五、b站动态推送

- 以`图片`的形式自动推送b站[@Warma](https://space.bilibili.com/53456)和[@warma养鸽场](https://space.bilibili.com/106320250)的动态/视频投稿到到上述频道
- 将动态中的**图片**逐个提取并发送到上述频道


## 六、MC服务器消息互通

- 在q群：
    - [沃玛岛MC插件服务器消息互通](https://qm.qq.com/q/i3QRaRjcgS)
    - [沃玛岛MC MOD务器消息互通](https://qm.qq.com/q/L63SB3q4kq)
- 与频道：
    - [🏖️「MC插件服」消息互通](https://pd.qq.com/g/WarmaFans1026/text/596492015)
    - [🛠️「MC MOD服」消息互通](https://pd.qq.com/g/WarmaFans1026/text/670297897)
- 实现**三向**消息互通(**频道**&lt;=&gt;**q群**&lt;=&gt;**MC服务器**)
- 现已支持发送图片(mc客户端需要安装模组[[ChatImage]聊天栏图片显示](https://www.mcmod.cn/class/9111.html))


## 七、问卷审核系统
> 频道与Q群的验证码**不能复用**，如需在频道和Q群都加入，请分别填写问卷
- 实现了之前频道的问卷审核系统
- 当申请加入频道[沃玛「Warma」](http://warma.fans)或[沃玛频道——🍉日常闲聊](https://qm.qq.com/q/X69yIwDWEw)的时候，用户需要在[问卷网页](https://q.warma.fans/)填写问卷并获得验证码
- 用户需要根据不同的平台提交验证码：
    - **Q群**：用户需要将验证码作为入群问题的答案提交入群申请
    - **频道**：用户需要将验证码发送到子频道[⭐「欢迎光临」获取发言权限](https://pd.qq.com/g/WarmaFans1026/text/1300336)
- 店员会尝试自动审核收到的问卷
- 若自动审核失败，则自动发送到管理群，由管理员手动审核
- 若用户已加入[沃玛频道——🍉日常闲聊](https://qm.qq.com/q/X69yIwDWEw)，自动通过其加入其他子群的入群申请
